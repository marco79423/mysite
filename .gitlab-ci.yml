image: docker:stable

services:
  - docker:dind

stages:
  - build
  - deploy

build-frontend:
  stage: build
  only:
    changes:
      - frontend/**/*
      - deploy/**/*
  before_script:
    - docker --version
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - BACKEND_SERVER_URL=/backend
  script:
    - docker build
      --file frontend/Dockerfile
      --build-arg REACT_APP_BACKEND_SERVER_URL=$BACKEND_SERVER_URL
      --tag marco79423/mysite-frontend:latest
      .
    - docker push marco79423/mysite-frontend:latest
    - docker tag marco79423/mysite-frontend:latest marco79423/mysite-frontend:$CI_COMMIT_REF_NAME
    - docker push marco79423/mysite-frontend:$CI_COMMIT_REF_NAME
  coverage: '/^Statements\s+: ([\d.]+%)/'

build-backend:
  stage: build
  only:
    changes:
      - backend/**/*
      - content/**/*
      - deploy/**/*
  before_script:
    - docker --version
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - apk update && apk add -U git
    - STATIC_URL=/backend/static/
    - REPO_VERSION=`git describe --tags`
  script:
    - docker build
      --file backend/Dockerfile
      --build-arg STATIC_URL=$STATIC_URL
      --build-arg REPO_VERSION=$REPO_VERSION
      --tag marco79423/mysite-backend:latest
      .
    - docker push marco79423/mysite-backend:latest
    - docker tag marco79423/mysite-backend:latest marco79423/mysite-backend:$CI_COMMIT_REF_NAME
    - docker push marco79423/mysite-backend:$CI_COMMIT_REF_NAME
  coverage: '/^TOTAL\s+\d+\s+\d+\s+(\d+\%)$/'

deploy:
  image: alpine:latest
  stage: deploy
  when: on_success
  before_script:
    - apk add --no-cache curl
  script:
    - curl -X POST -F token=624fc6127e111c5283d4b6469b04b2 -F ref=master https://gitlab.com/api/v4/projects/14652112/trigger/pipeline
